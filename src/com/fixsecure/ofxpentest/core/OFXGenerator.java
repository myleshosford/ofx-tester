package com.fixsecure.ofxpentest.core;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.UUID;

/**
 *
 * @author Myles Hosford
 */
public class OFXGenerator {
    
    static final String USERNAME = "myles";
    static final String PASSWORD = "password1!";
    static final String APPID = "ofxapp";
    static final String APPVER = "1234";
    
        
    
        public static String getOFXRequest(String msgType, int version) {
            String request = "";
            if (version == 1) {
                request = getV1OFXHeader(null,null);
            } else if (version == 2) {
                request = getV2OFXHeader(null, null);
            } else {
                System.out.println("Unknown OFX Header Version.");
            }
            
            request = request + "\n<ofx>";
                        
            if (msgType.equalsIgnoreCase("Logon")) {
                request = request + getLogonRequest(USERNAME,PASSWORD, APPID, APPVER);
            } else if (msgType.equalsIgnoreCase("Account List")) {
                request = request + getLogonRequest(USERNAME,PASSWORD, APPID, APPVER) + getAccountListRequest();
            } else if (msgType.equalsIgnoreCase("Change Password")) {
               request = request + getLogonRequest(USERNAME,PASSWORD, APPID, APPVER) + changePasswordRequest(USERNAME,PASSWORD);  
            } else if (msgType.equalsIgnoreCase("Tax Form")) {
                request = request + getLogonRequest(USERNAME,PASSWORD, APPID, APPVER) + getTaxFormRequest();
            } 
            
            else {
                System.out.println("Unknown Message Type");
                request = "Unknown Message Type";
            }
            
            request = request + "\n</ofx>";
            
            return request;
        }
        
          /**
         * Returns the current date in the format yyyyMMddHHmmss eg
         * 20080613230844
         * @return
         */
        private static String getCurrentDate() {
                SimpleDateFormat format = new SimpleDateFormat("yyyyMMddHHmmss");
                return format.format(new Date());
        }
    
    
    
        /**
         * Returns the V1 OFX header.
         * @param oldFileID
         * @param newFileID
         * @return
         */
        public static String getV1OFXHeader(String oldFileID, String newFileID) {
                if (oldFileID == null) oldFileID = "NONE";
                if (newFileID == null) newFileID = "NONE";
                return
                "OFXHEADER:100\n" +
                "DATA:OFXSGML\n" +
                "VERSION:102\n" +
                "SECURITY:NONE\n" +
                "ENCODING:USASCII\n" +
                "CHARSET:1252\n" +
                "COMPRESSION:NONE\n" +
                "OLDFILEUID:" + oldFileID + "\n" +
                "NEWFILEUID:" + newFileID + "\n";
        }
        
         /**
         * Returns the V2 OFX header.
         * @param oldFileID
         * @param newFileID
         * @return
         */
        public static String getV2OFXHeader(String oldFileID, String newFileID) {
                if (oldFileID == null) oldFileID = "NONE";
                if (newFileID == null) newFileID = "NONE";
                return
                "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>" +
                "<?OFX OFXHEADER=\"200\" VERSION=\"202\" SECURITY=\"NONE\" OLDFILEUID=\"" + oldFileID + "\" NEWFILEUID=\"" + newFileID + " \" ?>\n";
        }
        
        
    public static String getLogonRequest(String userID, String userPass, String appid, String appver) {
            return
            "\n<SIGNONMSGSRQV1>\n" +
            "<SONRQ>\n" +
            "<DTCLIENT>" + getCurrentDate() + "\n" +
            "<USERID>" + userID + "\n" +
            "<USERPASS>" + userPass + "\n" +
            "<LANGUAGE>ENG\n" +
            "<APPID>" + appid + "\n" +
            "<APPVER>" + appver + "\n" +
            "</SONRQ>\n" +
            "</SIGNONMSGSRQV1>";
    }
    
    public static String getAccountListRequest() {
            return
            "\n<SIGNUPMSGSRQV1>\n" +
            "<ACCTINFOTRNRQ>\n" +
            "<TRNUID>" + generateID() + "\n" +
            "<ACCTINFORQ>\n" +
            "<DTACCTUP>19700101000000\n" + //The date that we last received the account list
            "</ACCTINFORQ>\n" +
            "</ACCTINFOTRNRQ>\n" +
            "</SIGNUPMSGSRQV1>";
    }
     
    public static String generateID() {
            return UUID.randomUUID().toString().toUpperCase();
    }
    
    public static String changePasswordRequest(String user, String pass) {
        
             return
            "\n<PINCHTRNRQ>\n" +
            "<TRNUID>" + generateID() + "\n" +
            "<PINCHRQ>\n" +
            "<USERID>" + user + "\n" +
            "<NEWUSERPASS>" + pass + "\n" +
            "</PINCHRQ>\n" +
            "</PINCHTRNRQ>";
    }
    
    public static String getTaxFormRequest() {
        
             return
            "\n<TAX1099MSGSRQV1>\n" +
            "<TAX1099TRNRQ>\n" +
            "<TRNUID>" + generateID() + "\n" +
            "<TAX1099RQ>\n" +
            "<RECID>accountnum\n" +
            "<TAXYEAR>2013\n" +
            "</TAX1099RQ>\n" +
            "</TAX1099TRNRQ>\n" +
            "</TAX1099MSGSRQV1>";
             
    }
        

}
